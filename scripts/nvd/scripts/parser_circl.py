import json
import sys
import requests

api_url = "https://cve.circl.lu/api/cve/"
in_file_path = '../data/nvd_raw.json'
out_file_path = "../data/cves.json"
cve_list = []
data = []

with open(in_file_path, "r") as in_file:
    data = json.load(in_file)

cves = data["cves"]

current_cve = 0
total_cves = len(cves)

for cve, val in cves.items():
    current_cve += 1
    print(f"Currently analyzing CVE {current_cve} of {total_cves}")

    exploitable = False
    if "refmap" in val:
        refmap = val["refmap"]
        confirm = []
        if "confirm" in refmap:
            confirm = refmap["confirm"]
            for c in confirm:
                if "exploit" in c.lower():
                    exploitable = True
        misc = []
        if "misc" in refmap:
            misc = refmap["misc"]
            for m in misc:
                if "exploit" in m.lower():
                    exploitable = True
        if "exploit-db" in refmap:
            exploitable = True

    try:
        print(f'{api_url}{cve}')
        cve_data = requests.get(f'{api_url}{cve}').json()
        cve_list.append({
            "cve": cve,
            "cwe": cve_data["cwe"] or "N.D.",
            "cvss": cve_data["cvss"] or "N.D.",
            "exploitable": exploitable
        })
    except:
        print(f"Error trying to get {api_url + cve}")

with open(out_file_path, "w") as out_file:
    json.dump(cve_list, out_file, indent=2)



